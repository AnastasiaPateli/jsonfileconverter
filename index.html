<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tenancy Agreement Generator</title>
    <!-- Load libraries with fallback CDN -->
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script>
        // Fallback for docx.js
        if (!window.docx) {
            document.write('<script src="https://cdn.jsdelivr.net/npm/docx@7.8.2/build/index.min.js"><\/script>');
        }
        // Fallback for FileSaver.js
        if (!window.saveAs) {
            document.write('<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"><\/script>');
        }
        // Fallback for JSZip
        if (!window.JSZip) {
            document.write('<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"><\/script>');
        }
    </script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .upload-section, .agreements-section {
            margin-bottom: 20px;
        }
        button, input[type="file"] {
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
        }
        .agreement {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 10px;
        }
        .download-btn, .download-all-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            margin: 4px 2px;
            cursor: pointer;
        }
        .error {
            color: red;
            margin: 10px 0;
        }
        .agreement-count {
            margin: 10px 0;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="upload-section">
        <h2>Tenancy Agreement Generator</h2>
        <input type="file" id="jsonFile" accept=".json">
        <div id="error" class="error"></div>
        <div id="downloadAllContainer"></div> <!-- Container for Download All button and agreement count -->
    </div>
    <div class="agreements-section" id="agreements"></div>

    <script>
        const jsonFileInput = document.getElementById('jsonFile');
        const agreementsDiv = document.getElementById('agreements');
        const errorDiv = document.getElementById('error');
        const downloadAllContainer = document.getElementById('downloadAllContainer');
        let agreementBlobs = []; // Store blobs for all agreements

        // Check if required libraries are loaded
        window.addEventListener('load', () => {
            if (!window.docx || !window.saveAs || !window.JSZip) {
                errorDiv.textContent = 'Required libraries (docx.js, FileSaver.js, or JSZip) failed to load. Please try again later.';
                console.error('Library Load Failure:', { docx: !!window.docx, saveAs: !!window.saveAs, JSZip: !!window.JSZip });
            }
        });

        jsonFileInput.addEventListener('change', handleFileUpload);

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                errorDiv.textContent = 'No file selected.';
                console.warn('No file selected');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    agreementBlobs = []; // Reset blobs on new upload
                    generateAgreements(data);
                    errorDiv.textContent = '';
                } catch (error) {
                    errorDiv.textContent = 'Error parsing JSON file: ' + error.message;
                    console.error('JSON Parse Error:', error);
                }
            };
            reader.onerror = function() {
                errorDiv.textContent = 'Error reading file.';
                console.error('FileReader Error:', reader.error);
            };
            reader.readAsText(file);
        }

        function generateAgreements(data) {
            agreementsDiv.innerHTML = '';
            const fields = Array.isArray(data.field_list) ? data.field_list : [];
            const tenant = {
                ...data.applicant_detail || {},
                tin: data.tin || (fields.length > 0 ? fields[0].tin || 'Not Available' : 'Not Available')
            };
            console.log('Tenant data:', tenant);

            if (!fields.length) {
                errorDiv.textContent = 'No fields found in the JSON data.';
                console.warn('No fields in JSON');
                return;
            }

            // Group fields by owner TIN, skipping if owner TIN matches tenant TIN
            const agreementsByTin = {};

            fields.forEach(field => {
                const fieldInfo = field.field_info || {};
                const propertyList = Array.isArray(field.field_property_list) ? field.field_property_list : [];
                const geospatialData = field.field_geospatial_data || {};

                propertyList.forEach(property => {
                    const tin = property.tin || 'Unknown';
                    if (tin === tenant.tin) {
                        console.log(`Skipping agreement for owner TIN ${tin} as it matches tenant TIN ${tenant.tin}`);
                        return;
                    }
                    if (!agreementsByTin[tin]) {
                        agreementsByTin[tin] = {
                            owner: {
                                tin: property.tin || 'Unknown',
                                full_name: property.full_name || 'Unknown Owner',
                                doy: 'Α Σερρών'
                            },
                            fields: []
                        };
                    }
                    agreementsByTin[tin].fields.push({
                        serial_number: geospatialData.serial_number || '-',
                        community: geospatialData.community_code || 'Unknown',
                        location: fieldInfo.location || 'Unknown',
                        atak: property.atak || '-',
                        other_cartographic_background: fieldInfo.other_cartographic_background || '-',
                        cartographic_background: geospatialData.cartographic_background || '-',
                        area_ha: property.area_participation_atak || '0'
                    });
                });
            });

            // Generate agreements for each unique TIN
            Object.values(agreementsByTin).forEach(agreement => {
                const agreementDiv = document.createElement('div');
                agreementDiv.className = 'agreement';
                
                const title = document.createElement('h3');
                title.textContent = `Agreement for ${agreement.owner.full_name} (TIN: ${agreement.owner.tin})`;
                agreementDiv.appendChild(title);

                const table = document.createElement('table');
                table.border = '1';
                table.style.width = '100%';
                table.innerHTML = `
                    <tr>
                        <th>Α/Α</th>
                        <th>ΚΟΙΝΟΤΗΤΑ (κωδ.)</th>
                        <th>ΤΟΠΟΘΕΣΙΑ</th>
                        <th>Α.Τ.Α.Κ.</th>
                        <th>ΑΡ.ΚΤΗΜ.ΤΕΜ.</th>
                        <th>ΧΑΡΤΟΓΡΑΦΙΚΟ</th>
                        <th>ΕΚΤΑΣΗ (Ha)</th>
                    </tr>
                `;
                agreement.fields.forEach((field, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${field.community}</td>
                        <td>${field.location}</td>
                        <td>${field.atak}</td>
                        <td>${field.other_cartographic_background}</td>
                        <td>${field.cartographic_background}</td>
                        <td>${field.area_ha}</td>
                    `;
                    table.appendChild(row);
                });
                agreementDiv.appendChild(table);

                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-btn';
                downloadBtn.textContent = 'Download Agreement';
                downloadBtn.onclick = () => {
                    try {
                        generateDocx(agreement, tenant);
                    } catch (error) {
                        errorDiv.textContent = 'Error generating document: ' + error.message;
                        console.error('Document Generation Error:', error);
                    }
                };
                agreementDiv.appendChild(downloadBtn);

                agreementsDiv.appendChild(agreementDiv);

                // Generate and store blob for this agreement
                generateDocx(agreement, tenant, true);
            });

            // Add or update Download All button and agreement count at the top
            downloadAllContainer.innerHTML = '';
            const totalAgreements = Object.keys(agreementsByTin).length;
            if (totalAgreements > 0) {
                const countDiv = document.createElement('div');
                countDiv.className = 'agreement-count';
                countDiv.textContent = `Total Agreements Generated: ${totalAgreements}`;
                downloadAllContainer.appendChild(countDiv);

                const downloadAllBtn = document.createElement('button');
                downloadAllBtn.className = 'download-all-btn';
                downloadAllBtn.textContent = 'Download All Agreements';
                downloadAllBtn.onclick = downloadAllAgreements;
                downloadAllContainer.appendChild(downloadAllBtn);
            }
        }

        function generateDocx(agreement, tenant, storeBlob = false) {
            if (!window.docx || !window.saveAs) {
                throw new Error('Required libraries (docx.js or FileSaver.js) are not loaded.');
            }

            const { Document, Paragraph, TextRun, Table, TableRow, TableCell, WidthType } = docx;

            const doc = new Document({
                sections: [{
                    children: [
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "ΙΔΙΩΤΙΚΟ ΣΥΜΦΩΝΗΤΙΚΟ ΑΓΡΟΜΙΣΘΩΣΗΣ",
                                    bold: true,
                                    size: 28,
                                    font: "Arial"
                                })
                            ],
                            alignment: "center"
                        }),
                        new Paragraph({ children: [new TextRun({ text: "", size: 24 })] }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: `Σήμερα την 1η Νοεμβρίου 2024 στο Δημητρίτσι οι υπογράφοντες το συμφωνητικό αυτό`,
                                    size: 24,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: `αφενός ο/η ${agreement.owner.full_name}, κάτοικος -, οδός -, αρ. -, Α.Φ.Μ ${agreement.owner.tin}, Δ.Ο.Υ ${agreement.owner.doy}`,
                                    size: 24,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: `και αφετέρου ο/η ${tenant.first_name || 'Unknown'} ${tenant.last_name || 'Tenant'} του ${tenant.father_name || '-'}, επαγγέλματος αγρότης, κάτοικος ${tenant.post_code || '-'}, οδός ${tenant.street || '-'}, αρ. ${tenant.street_number || '-'}, Α.Φ.Μ ${tenant.tin !== undefined ? tenant.tin : 'Not Available'}, Δ.Ο.Υ Α Σερρών`,
                                    size: 24,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "συμφώνησαν από κοινού και αποδέχτηκαν τα εξής:",
                                    size: 24,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "1. ΜΙΣΘΙΟ. Ο πρώτος συμβαλλόμενος (\"εκμισθωτή\") έχει στην αποκλειστική κυριότητα, νομή και κατοχή του τους κάτωθι αγρούς:",
                                    size: 24,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Table({
                            width: { size: 100, type: WidthType.PERCENTAGE },
                            rows: [
                                new TableRow({
                                    children: [
                                        new TableCell({ children: [new Paragraph("Α/Α")], width: { size: 5, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph("ΚΟΙΝΟΤΗΤΑ (κωδ.)")], width: { size: 15, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph("ΤΟΠΟΘΕΣΙΑ")], width: { size: 20, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph("Α.Τ.Α.Κ.")], width: { size: 20, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph("ΑΡ.ΚΤΗΜ.ΤΕΜ.")], width: { size: 15, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph("ΧΑΡΤΟΓΡΑΦΙΚΟ")], width: { size: 20, type: WidthType.PERCENTAGE } }),
                                        new TableCell({ children: [new Paragraph("ΕΚΤΑΣΗ (Ha)")], width: { size: 10, type: WidthType.PERCENTAGE } })
                                    ]
                                }),
                                ...agreement.fields.map((field, index) => new TableRow({
                                    children: [
                                        new TableCell({ children: [new Paragraph(index + 1)] }),
                                        new TableCell({ children: [new Paragraph(field.community)] }),
                                        new TableCell({ children: [new Paragraph(field.location)] }),
                                        new TableCell({ children: [new Paragraph(field.atak)] }),
                                        new TableCell({ children: [new Paragraph(field.other_cartographic_background)] }),
                                        new TableCell({ children: [new Paragraph(field.cartographic_background)] }),
                                        new TableCell({ children: [new Paragraph(field.area_ha.toString())] })
                                    ]
                                }))
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "Ο εκμισθωτής εκμισθώνει με το παρόν συμφωνητικό στο μισθωτή τους παραπάνω αγρούς, με τους εξής όρους και συμφωνίες που είναι όλοι ουσιώδεις:",
                                    size: 24,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "2. ΔΙΑΡΚΕIΑ. Η διάρκεια της παρούσας μίσθωσης ορίζεται: Αρχίζει την 1η ΝΟΕΜΒΡΙΟΥ 2024 και λήγει την 31η ΟΚΤΩΒΡΙΟΥ 2032.",
                                    size: 24,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "3. ΜΙΣΘΩΜΑ. Το ετήσιο μίσθωμα ορίζεται σε ευρώ - /ΣΤΡ",
                                    size: 24,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "4. ΧΡΗΣΗ. Ο μίσθιος αγρός θα χρησιμοποιηθεί για αποκλειστικά για αγροτική καλλιέργεια. Απαγορεύεται απόλυτα οποιαδήποτε μετατροπή της χρήσης ή του τρόπου εκμετάλλευσης του μισθίου, η ολική ή μερική υπομίσθωσή του, ή η με οποιοδήποτε τρόπο, με ή χωρίς αντάλλαγμα παραχώρηση της χρήσης του μισθίου σε τρίτους καθώς και η πρόσληψη συνεταίρου, χωρίς την προηγούμενη έγγραφη συναίνεση του εκμισθωτή.",
                                    size: 24,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "5. ΚΑΛΗ ΧΡΗΣΗ ΤΟΥ ΜΙΣΘΙΟΥ. Ο μισθωτής υποχρεούται να κάνει καλή χρήση του μισθίου, να το εκμεταλλευεται με επιμέλεια και σύμφωνα με τον προορισμό του και να το διατηρεί κατάλληλο για τη συμφωνημένη χρήση, κάνοντας με αποκλειστική δαπάνη και επιμέλεια του κάθε είδους τακτικές ή έκτακτες επισκευές ή βελτιώσεις, διαφορετικά, ευθύνεται για αποζημίωση για τις φθορές και τις βλάβες που προξενήθηκαν σ' αυτό.",
                                    size: 24,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "Το παρόν μισθωτήριο διαβάστηκε και έγινε αποδεκτό από τούς συμβαλλόμενους, υπογράφη από αυτούς και ο καθένας έλαβε από ένα όμοιο αντίτυπο.",
                                    size: 24,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "ΟΙ ΣΥΜΒΑΛΛΟΜΕΝΟΙ",
                                    bold: true,
                                    size: 24,
                                    font: "Arial"
                                })
                            ],
                            alignment: "center"
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "Ο ΕΚΜΙΣΘΩΤΗΣ ____________________  Ο ΜΙΣΘΩΤΗΣ ____________________",
                                    size: 24,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "ΘΕΩΡΗΘΗΚΕ ____________________",
                                    size: 24,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "                                   ",
                                    size: 35,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "                                   ",
                                    size: 35,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "                                   ",
                                    size: 35,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "                                   ",
                                    size: 35,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "                                   ",
                                    size: 35,
                                    font: "Arial"
                                })
                            ]
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "Για το γνήσιο των υπογραφών",
                                    size: 24,
                                    font: "Arial"
                                })
                            ],
                            alignment: "center"
                        }),
                        new Paragraph({
                            children: [
                                new TextRun({
                                    text: "ΗΜΕΡΟΜΗΝΙΑ: 1η Νοεμβρίου 2024",
                                    size: 24,
                                    font: "Arial"
                                })
                            ],
                            alignment: "center"
                        })
                    ]
                }]
            });

            return docx.Packer.toBlob(doc).then(blob => {
                if (storeBlob) {
                    agreementBlobs.push({ blob, filename: `Agreement_${agreement.owner.tin}_${agreement.owner.full_name}.docx` });
                } else {
                    saveAs(blob, `Agreement_${agreement.owner.tin}_${agreement.owner.full_name}.docx`);
                }
                console.log('Document generated successfully.');
            }).catch(error => {
                errorDiv.textContent = 'Error generating document: ' + error.message;
                console.error('Document Generation Error:', error);
            });
        }

        function downloadAllAgreements() {
            if (!window.JSZip || agreementBlobs.length === 0) {
                errorDiv.textContent = 'Unable to download all agreements. JSZip not loaded or no agreements generated.';
                console.error('Download All Failure:', { JSZip: !!window.JSZip, agreementBlobsLength: agreementBlobs.length });
                return;
            }

            const zip = new JSZip();
            agreementBlobs.forEach((item, index) => {
                zip.file(item.filename, item.blob);
            });

            zip.generateAsync({ type: 'blob' }).then(content => {
                saveAs(content, 'All_Agreements_' + new Date().toISOString().slice(0, 10) + '.zip');
                console.log('All agreements downloaded as ZIP.');
            }).catch(error => {
                errorDiv.textContent = 'Error creating ZIP file: ' + error.message;
                console.error('ZIP Generation Error:', error);
            });
        }
    </script>
</body>
</html>
