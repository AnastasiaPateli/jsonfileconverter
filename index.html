<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Î™Î´Î¹Ï‰Ï„Î¹ÎºÏŒ Î£Ï…Î¼Ï†Ï‰Î½Î·Ï„Î¹ÎºÏŒ Î‘Î³ÏÎ¿Î¼Î¯ÏƒÎ¸Ï‰ÏƒÎ·Ï‚</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        .upload-section {
            background: #ecf0f1;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 4px solid #3498db;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            transition: background-color 0.3s;
            margin-right: 15px;
        }

        .file-input-wrapper:hover {
            background: #2980b9;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .clear-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .clear-btn:hover {
            background: #c0392b;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .stat-item {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-align: center;
            min-width: 120px;
        }

        .stat-item strong {
            display: block;
            font-size: 1.4em;
        }

        .agreement {
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .agreement h3 {
            color: #2c3e50;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #34495e;
            color: white;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .download-btn, .download-all-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin: 5px;
        }

        .download-btn:hover, .download-all-btn:hover {
            background: linear-gradient(135deg, #229954, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .download-all-btn {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            font-size: 16px;
            padding: 15px 30px;
            margin: 20px auto;
            display: block;
            width: fit-content;
        }

        .download-all-btn:hover {
            background: linear-gradient(135deg, #7d3c98, #8e44ad);
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }

        .loading {
            display: none;
            color: #3498db;
            font-weight: bold;
            margin: 10px 0;
        }

        .loading::after {
            content: "";
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60% { content: "..."; }
            80%, 100% { content: ""; }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            table {
                font-size: 12px;
            }
            
            .stats {
                justify-content: center;
            }
            
            .stat-item {
                min-width: 100px;
            }
        }

        .field-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .owner-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ¾ Î™Î´Î¹Ï‰Ï„Î¹ÎºÏŒ Î£Ï…Î¼Ï†Ï‰Î½Î·Ï„Î¹ÎºÏŒ Î‘Î³ÏÎ¿Î¼Î¯ÏƒÎ¸Ï‰ÏƒÎ·Ï‚</h1>
        
        <div class="upload-section">
            <h3>ğŸ“ Î•Ï€Î¹Î»Î¿Î³Î® Î‘ÏÏ‡ÎµÎ¯Î¿Ï… JSON</h3>
            <div class="file-input-wrapper">
                <input type="file" id="jsonFile" accept=".json">
                ğŸ“¤ Î•Ï€Î¹Î»Î¿Î³Î® Î‘ÏÏ‡ÎµÎ¯Î¿Ï…
            </div>
            <button class="clear-btn" id="clearBtn" style="display: none;">ğŸ—‘ï¸ ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚</button>
            
            <div id="error" class="error"></div>
            <div id="success" class="success"></div>
            <div id="loading" class="loading">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½</div>
            
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-item">
                    <strong id="totalFields">0</strong>
                    <small>Î£ÏÎ½Î¿Î»Î¿ Î‘Î³ÏÏÎ½</small>
                </div>
                <div class="stat-item">
                    <strong id="totalOwners">0</strong>
                    <small>Î™Î´Î¹Î¿ÎºÏ„Î®Ï„ÎµÏ‚</small>
                </div>
                <div class="stat-item">
                    <strong id="totalArea">0</strong>
                    <small>Î£Ï…Î½Î¿Î»Î¹ÎºÎ® ÎˆÎºÏ„Î±ÏƒÎ· (Ha)</small>
                </div>
            </div>
        </div>

        <div class="agreements-section" id="agreements"></div>
    </div>

    <script>
        // State management
        const state = {
            agreements: [],
            tenant: {},
            isProcessing: false
        };

        // DOM elements
        const elements = {
            jsonFile: document.getElementById('jsonFile'),
            clearBtn: document.getElementById('clearBtn'),
            agreements: document.getElementById('agreements'),
            error: document.getElementById('error'),
            success: document.getElementById('success'),
            loading: document.getElementById('loading'),
            stats: document.getElementById('stats'),
            totalFields: document.getElementById('totalFields'),
            totalOwners: document.getElementById('totalOwners'),
            totalArea: document.getElementById('totalArea')
        };

        // Utility functions
        const utils = {
            showError(message) {
                elements.error.textContent = message;
                elements.error.style.display = 'block';
                elements.success.style.display = 'none';
                console.error('Error:', message);
            },

            showSuccess(message) {
                elements.success.textContent = message;
                elements.success.style.display = 'block';
                elements.error.style.display = 'none';
                console.log('Success:', message);
            },

            showLoading(show = true) {
                elements.loading.style.display = show ? 'block' : 'none';
                state.isProcessing = show;
            },

            formatNumber(num) {
                return parseFloat(num).toFixed(2);
            },

            sanitizeFilename(filename) {
                return filename.replace(/[<>:"/\\|?*]/g, '_').substring(0, 100);
            },

            validateJSON(data) {
                if (!data || typeof data !== 'object') {
                    throw new Error('ÎœÎ· Î­Î³ÎºÏ…ÏÎ± Î´ÎµÎ´Î¿Î¼Î­Î½Î± JSON');
                }
                
                if (!data.applicant_detail) {
                    throw new Error('Î›ÎµÎ¯Ï€Î¿Ï…Î½ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î± Î¼Î¹ÏƒÎ¸Ï‰Ï„Î® (applicant_detail)');
                }
                
                if (!Array.isArray(data.field_list) || data.field_list.length === 0) {
                    throw new Error('Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±Î³ÏÎ¿Î¯ (field_list)');
                }
                
                return true;
            }
        };

        // Event listeners
        elements.jsonFile.addEventListener('change', handleFileUpload);
        elements.clearBtn.addEventListener('click', clearData);

        // Check library availability
        window.addEventListener('load', () => {
            if (!window.docx || !window.saveAs) {
                utils.showError('Î‘Ï€Î±Î¹Ï„Î¿ÏÎ¼ÎµÎ½ÎµÏ‚ Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎµÏ‚ (docx.js Î® FileSaver.js) Î´ÎµÎ½ Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎ±Î½. Î”Î¿ÎºÎ¹Î¼Î¬ÏƒÏ„Îµ Î¾Î±Î½Î¬.');
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (state.isProcessing) {
                utils.showError('Î Î±ÏÎ±ÎºÎ±Î»Ï Ï€ÎµÏÎ¹Î¼Î­Î½ÎµÏ„Îµ Î½Î± Î¿Î»Î¿ÎºÎ»Î·ÏÏ‰Î¸ÎµÎ¯ Î· Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· Î´Î¹Î±Î´Î¹ÎºÎ±ÏƒÎ¯Î±...');
                return;
            }

            utils.showLoading(true);
            elements.clearBtn.style.display = 'inline-block';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    utils.validateJSON(data);
                    
                    setTimeout(() => {
                        generateAgreements(data);
                        utils.showLoading(false);
                        utils.showSuccess(`Î¦Î¿ÏÏ„ÏÎ¸Î·ÎºÎ±Î½ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚ ${state.agreements.length} ÏƒÏ…Î¼Ï†Ï‰Î½Î·Ï„Î¹ÎºÎ¬!`);
                    }, 500);
                    
                } catch (error) {
                    utils.showLoading(false);
                    utils.showError('Î£Ï†Î¬Î»Î¼Î± Î±Î½Î¬Î»Ï…ÏƒÎ·Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï… JSON: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                utils.showLoading(false);
                utils.showError('Î£Ï†Î¬Î»Î¼Î± Î±Î½Î¬Î³Î½Ï‰ÏƒÎ·Ï‚ Î±ÏÏ‡ÎµÎ¯Î¿Ï….');
            };
            
            reader.readAsText(file);
        }

        function clearData() {
            elements.jsonFile.value = '';
            elements.agreements.innerHTML = '';
            elements.clearBtn.style.display = 'none';
            elements.stats.style.display = 'none';
            elements.error.style.display = 'none';
            elements.success.style.display = 'none';
            state.agreements = [];
            state.tenant = {};
        }

        function generateAgreements(data) {
            state.tenant = data.applicant_detail || {};
            const fields = data.field_list || [];
            const agreementsByTin = {};
            let totalFields = 0;
            let totalArea = 0;

            // Process fields and group by owner TIN
            fields.forEach(field => {
                const fieldInfo = field.field_info || {};
                const propertyList = Array.isArray(field.field_property_list) ? field.field_property_list : [];
                const geospatialData = field.field_geospatial_data || {};

                propertyList.forEach(property => {
                    const tin = property.tin || `unknown_${Math.random().toString(36).substr(2, 9)}`;
                    
                    if (!agreementsByTin[tin]) {
                        agreementsByTin[tin] = {
                            owner: {
                                tin: property.tin || 'Î†Î³Î½Ï‰ÏƒÏ„Î¿',
                                full_name: property.full_name || 'Î†Î³Î½Ï‰ÏƒÏ„Î¿Ï‚ Î™Î´Î¹Î¿ÎºÏ„Î®Ï„Î·Ï‚',
                                father_name: property.father_name || '-',
                                doy: 'Î‘\' Î£ÎµÏÏÏÎ½'
                            },
                            fields: []
                        };
                    }
                    
                    const area = parseFloat(property.area_participation_atak) || 0;
                    totalArea += area;
                    totalFields++;
                    
                    agreementsByTin[tin].fields.push({
                        community: fieldInfo.location ? fieldInfo.location.split('-')[0] : 'Î†Î³Î½Ï‰ÏƒÏ„Î·',
                        location: fieldInfo.location || 'Î†Î³Î½Ï‰ÏƒÏ„Î·',
                        atak: property.atak || '-',
                        property_number: property.legal_possession_document_number || '-',
                        cartographic: geospatialData.cartographic_background || '-',
                        area_ha: area.toFixed(2)
                    });
                });
            });

            state.agreements = Object.values(agreementsByTin);
            
            // Update stats
            elements.totalFields.textContent = totalFields;
            elements.totalOwners.textContent = state.agreements.length;
            elements.totalArea.textContent = totalArea.toFixed(2);
            elements.stats.style.display = 'flex';

            renderAgreements();
        }

        function renderAgreements() {
            elements.agreements.innerHTML = '';

            if (state.agreements.length > 1) {
                const downloadAllBtn = document.createElement('button');
                downloadAllBtn.className = 'download-all-btn';
                downloadAllBtn.innerHTML = 'ğŸ“¦ Î›Î®ÏˆÎ· ÎŒÎ»Ï‰Î½ Ï„Ï‰Î½ Î£Ï…Î¼Ï†Ï‰Î½Î·Ï„Î¹ÎºÏÎ½ (ZIP)';
                downloadAllBtn.onclick = () => downloadAllAgreements();
                elements.agreements.appendChild(downloadAllBtn);
            }

            state.agreements.forEach((agreement, index) => {
                const agreementDiv = document.createElement('div');
                agreementDiv.className = 'agreement';
                
                const totalAreaForOwner = agreement.fields.reduce((sum, field) => 
                    sum + parseFloat(field.area_ha), 0
                );
                
                agreementDiv.innerHTML = `
                    <h3>ğŸ“‹ Î£Ï…Î¼Ï†Ï‰Î½Î·Ï„Î¹ÎºÏŒ #${index + 1}</h3>
                    <div class="owner-info">
                        <strong>Î™Î´Î¹Î¿ÎºÏ„Î®Ï„Î·Ï‚:</strong> ${agreement.owner.full_name}<br>
                        <strong>Î‘.Î¦.Îœ:</strong> ${agreement.owner.tin}<br>
                        <strong>Î£ÏÎ½Î¿Î»Î¿ Î±Î³ÏÏÎ½:</strong> ${agreement.fields.length}<br>
                        <strong>Î£Ï…Î½Î¿Î»Î¹ÎºÎ® Î­ÎºÏ„Î±ÏƒÎ·:</strong> ${totalAreaForOwner.toFixed(2)} Ha
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Î‘/Î‘</th>
                                <th>ÎšÎŸÎ™ÎÎŸÎ¤Î—Î¤Î‘</th>
                                <th>Î¤ÎŸÎ ÎŸÎ˜Î•Î£Î™Î‘</th>
                                <th>Î‘.Î¤.Î‘.Îš.</th>
                                <th>Î‘Î¡.ÎšÎ¤Î—Îœ.Î¤Î•Îœ.</th>
                                <th>Î§Î‘Î¡Î¤ÎŸÎ“Î¡Î‘Î¦Î™ÎšÎŸ</th>
                                <th>Î•ÎšÎ¤Î‘Î£Î— (Ha)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${agreement.fields.map((field, fieldIndex) => `
                                <tr>
                                    <td>${fieldIndex + 1}</td>
                                    <td>${field.community}</td>
                                    <td>${field.location}</td>
                                    <td>${field.atak}</td>
                                    <td>${field.property_number}</td>
                                    <td>${field.cartographic}</td>
                                    <td>${field.area_ha}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-btn';
                downloadBtn.innerHTML = 'â¬‡ï¸ Î›Î®ÏˆÎ· Î£Ï…Î¼Ï†Ï‰Î½Î·Ï„Î¹ÎºÎ¿Ï';
                downloadBtn.onclick = () => generateDocx(agreement);
                agreementDiv.appendChild(downloadBtn);

                elements.agreements.appendChild(agreementDiv);
            });
        }

        async function downloadAllAgreements() {
            if (!window.JSZip) {
                // Fallback: download individual files
                utils.showError('Î”ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Î´Î¹Î±Î¸Î­ÏƒÎ¹Î¼Î· Î· Î´Ï…Î½Î±Ï„ÏŒÏ„Î·Ï„Î± ZIP. ÎšÎ±Ï„ÎµÎ²Î¬ÏƒÏ„Îµ Ï„Î± Î±ÏÏ‡ÎµÎ¯Î± Î¾ÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬.');
                return;
            }
            
            // For now, just download them individually
            for (let i = 0; i < state.agreements.length; i++) {
                await new Promise(resolve => {
                    setTimeout(() => {
                        generateDocx(state.agreements[i]);
                        resolve();
                    }, 1000 * i); // Stagger downloads
                });
            }
        }

        function generateDocx(agreement) {
            if (!window.docx || !window.saveAs) {
                utils.showError('Î‘Ï€Î±Î¹Ï„Î¿ÏÎ¼ÎµÎ½ÎµÏ‚ Î²Î¹Î²Î»Î¹Î¿Î¸Î®ÎºÎµÏ‚ Î´ÎµÎ½ ÎµÎ¯Î½Î±Î¹ Ï†Î¿ÏÏ„Ï‰Î¼Î­Î½ÎµÏ‚.');
                return;
            }

            try {
                const { Document, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType } = docx;
                const currentDate = new Date().toLocaleDateString('el-GR');

                const doc = new Document({
                    sections: [{
                        children: [
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "Î™Î”Î™Î©Î¤Î™ÎšÎŸ Î£Î¥ÎœÎ¦Î©ÎÎ—Î¤Î™ÎšÎŸ Î‘Î“Î¡ÎŸÎœÎ™Î£Î˜Î©Î£Î—Î£",
                                        bold: true,
                                        size: 28,
                                        font: "Times New Roman"
                                    })
                                ],
                                alignment: AlignmentType.CENTER,
                                spacing: { after: 400 }
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: `Î£Î®Î¼ÎµÏÎ± Ï„Î·Î½ ${currentDate} ÏƒÏ„Î¿ Î”Î·Î¼Î·Ï„ÏÎ¯Ï„ÏƒÎ¹ Î¿Î¹ Ï…Ï€Î¿Î³ÏÎ¬Ï†Î¿Î½Ï„ÎµÏ‚ Ï„Î¿ ÏƒÏ…Î¼Ï†Ï‰Î½Î·Ï„Î¹ÎºÏŒ Î±Ï…Ï„ÏŒ`,
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: `Î±Ï†ÎµÎ½ÏŒÏ‚ Î¿/Î· ${agreement.owner.full_name} Ï„Î¿Ï… ${agreement.owner.father_name || '-'}, ÎºÎ¬Ï„Î¿Î¹ÎºÎ¿Ï‚ -, Î¿Î´ÏŒÏ‚ -, Î±Ï. -, Î‘.Î¦.Îœ ${agreement.owner.tin}, Î”.ÎŸ.Î¥ ${agreement.owner.doy}`,
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: `ÎºÎ±Î¹ Î±Ï†ÎµÏ„Î­ÏÎ¿Ï… Î¿/Î· ${state.tenant.first_name || 'Î†Î³Î½Ï‰ÏƒÏ„Î¿'} ${state.tenant.last_name || 'ÎŒÎ½Î¿Î¼Î±'} Ï„Î¿Ï… ${state.tenant.father_name || '-'}, ÎµÏ€Î±Î³Î³Î­Î»Î¼Î±Ï„Î¿Ï‚ Î±Î³ÏÏŒÏ„Î·Ï‚, ÎºÎ¬Ï„Î¿Î¹ÎºÎ¿Ï‚ ${state.tenant.post_code || '-'}, Î¿Î´ÏŒÏ‚ ${state.tenant.street || '-'}, Î±Ï. ${state.tenant.street_number || '-'}, Î‘.Î¦.Îœ ${state.tenant.tin || '-'}, Î”.ÎŸ.Î¥ Î‘\' Î£ÎµÏÏÏÎ½`,
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "ÏƒÏ…Î¼Ï†ÏÎ½Î·ÏƒÎ±Î½ Î±Ï€ÏŒ ÎºÎ¿Î¹Î½Î¿Ï ÎºÎ±Î¹ Î±Ï€Î¿Î´Î­Ï‡Ï„Î·ÎºÎ±Î½ Ï„Î± ÎµÎ¾Î®Ï‚:",
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 300 }
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "1. ÎœÎ™Î£Î˜Î™ÎŸ. ",
                                        bold: true,
                                        size: 24,
                                        font: "Times New Roman"
                                    }),
                                    new TextRun({
                                        text: "ÎŸ Ï€ÏÏÏ„Î¿Ï‚ ÏƒÏ…Î¼Î²Î±Î»Î»ÏŒÎ¼ÎµÎ½Î¿Ï‚ (\"ÎµÎºÎ¼Î¹ÏƒÎ¸Ï‰Ï„Î®Ï‚\") Î­Ï‡ÎµÎ¹ ÏƒÏ„Î·Î½ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ® ÎºÏ…ÏÎ¹ÏŒÏ„Î·Ï„Î±, Î½Î¿Î¼Î® ÎºÎ±Î¹ ÎºÎ±Ï„Î¿Ï‡Î® Ï„Î¿Ï… Ï„Î¿Ï…Ï‚ ÎºÎ¬Ï„Ï‰Î¸Î¹ Î±Î³ÏÎ¿ÏÏ‚:",
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),

                            // Fields table
                            new Table({
                                width: { size: 100, type: WidthType.PERCENTAGE },
                                rows: [
                                    new TableRow({
                                        children: [
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Î‘/Î‘", bold: true })] })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ÎšÎŸÎ™ÎÎŸÎ¤Î—Î¤Î‘", bold: true })] })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Î¤ÎŸÎ ÎŸÎ˜Î•Î£Î™Î‘", bold: true })] })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Î‘.Î¤.Î‘.Îš.", bold: true })] })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Î‘Î¡.ÎšÎ¤Î—Îœ.Î¤Î•Îœ.", bold: true })] })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Î§Î‘Î¡Î¤ÎŸÎ“Î¡Î‘Î¦Î™ÎšÎŸ", bold: true })] })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Î•ÎšÎ¤Î‘Î£Î— (Ha)", bold: true })] })] })
                                        ]
                                    }),
                                    ...agreement.fields.map((field, index) => new TableRow({
                                        children: [
                                            new TableCell({ children: [new Paragraph(`${index + 1}`)] }),
                                            new TableCell({ children: [new Paragraph(field.community)] }),
                                            new TableCell({ children: [new Paragraph(field.location)] }),
                                            new TableCell({ children: [new Paragraph(field.atak)] }),
                                            new TableCell({ children: [new Paragraph(field.property_number)] }),
                                            new TableCell({ children: [new Paragraph(field.cartographic)] }),
                                            new TableCell({ children: [new Paragraph(field.area_ha.toString())] })
                                        ]
                                    }))
                                ]
                            }),

                            // Contract terms
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "ÎŸ ÎµÎºÎ¼Î¹ÏƒÎ¸Ï‰Ï„Î®Ï‚ ÎµÎºÎ¼Î¹ÏƒÎ¸ÏÎ½ÎµÎ¹ Î¼Îµ Ï„Î¿ Ï€Î±ÏÏŒÎ½ ÏƒÏ…Î¼Ï†Ï‰Î½Î·Ï„Î¹ÎºÏŒ ÏƒÏ„Î¿ Î¼Î¹ÏƒÎ¸Ï‰Ï„Î® Ï„Î¿Ï…Ï‚ Ï€Î±ÏÎ±Ï€Î¬Î½Ï‰ Î±Î³ÏÎ¿ÏÏ‚, Î¼Îµ Ï„Î¿Ï…Ï‚ ÎµÎ¾Î®Ï‚ ÏŒÏÎ¿Ï…Ï‚ ÎºÎ±Î¹ ÏƒÏ…Î¼Ï†Ï‰Î½Î¯ÎµÏ‚ Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ ÏŒÎ»Î¿Î¹ Î¿Ï…ÏƒÎ¹ÏÎ´ÎµÎ¹Ï‚:",
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { before: 300, after: 200 }
                            }),

                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "2. Î”Î™Î‘Î¡ÎšÎ•Î™Î‘. ",
                                        bold: true,
                                        size: 24,
                                        font: "Times New Roman"
                                    }),
                                    new TextRun({
                                        text: "Î— Î´Î¹Î¬ÏÎºÎµÎ¹Î± Ï„Î·Ï‚ Ï€Î±ÏÎ¿ÏÏƒÎ±Ï‚ Î¼Î¯ÏƒÎ¸Ï‰ÏƒÎ·Ï‚ Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹: Î‘ÏÏ‡Î¯Î¶ÎµÎ¹ Ï„Î·Î½ 1Î· ÎÎŸÎ•ÎœÎ’Î¡Î™ÎŸÎ¥ 2024 ÎºÎ±Î¹ Î»Î®Î³ÎµÎ¹ Ï„Î·Î½ 31Î· ÎŸÎšÎ¤Î©Î’Î¡Î™ÎŸÎ¥ 2032.",
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),

                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "3. ÎœÎ™Î£Î˜Î©ÎœÎ‘. ",
                                        bold: true,
                                        size: 24,
                                        font: "Times New Roman"
                                    }),
                                    new TextRun({
                                        text: "Î¤Î¿ ÎµÏ„Î®ÏƒÎ¹Î¿ Î¼Î¯ÏƒÎ¸Ï‰Î¼Î± Î¿ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÏƒÎµ ÎµÏ…ÏÏ _____ /ÏƒÏ„ÏÎ­Î¼Î¼Î±",
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),

                            // Additional contract terms...
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "4. Î§Î¡Î—Î£Î—. ",
                                        bold: true,
                                        size: 24,
                                        font: "Times New Roman"
                                    }),
                                    new TextRun({
                                        text: "ÎŸ Î¼Î¯ÏƒÎ¸Î¹Î¿Ï‚ Î±Î³ÏÏŒÏ‚ Î¸Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ Î±Ï€Î¿ÎºÎ»ÎµÎ¹ÏƒÏ„Î¹ÎºÎ¬ Î³Î¹Î± Î±Î³ÏÎ¿Ï„Î¹ÎºÎ® ÎºÎ±Î»Î»Î¹Î­ÏÎ³ÎµÎ¹Î±. Î‘Ï€Î±Î³Î¿ÏÎµÏÎµÏ„Î±Î¹ Î±Ï€ÏŒÎ»Ï…Ï„Î± Î¿Ï€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ Î¼ÎµÏ„Î±Ï„ÏÎ¿Ï€Î® Ï„Î·Ï‚ Ï‡ÏÎ®ÏƒÎ·Ï‚ Î® Ï„Î¿Ï… Ï„ÏÏŒÏ€Î¿Ï… ÎµÎºÎ¼ÎµÏ„Î¬Î»Î»ÎµÏ…ÏƒÎ·Ï‚ Ï„Î¿Ï… Î¼Î¹ÏƒÎ¸Î¯Î¿Ï…, Î· Î¿Î»Î¹ÎºÎ® Î® Î¼ÎµÏÎ¹ÎºÎ® Ï…Ï€Î¿Î¼Î¯ÏƒÎ¸Ï‰ÏƒÎ® Ï„Î¿Ï…, Î® Î· Î¼Îµ Î¿Ï€Î¿Î¹Î¿Î´Î®Ï€Î¿Ï„Îµ Ï„ÏÏŒÏ€Î¿, Î¼Îµ Î® Ï‡Ï‰ÏÎ¯Ï‚ Î±Î½Ï„Î¬Î»Î»Î±Î³Î¼Î± Ï€Î±ÏÎ±Ï‡ÏÏÎ·ÏƒÎ· Ï„Î·Ï‚ Ï‡ÏÎ®ÏƒÎ·Ï‚ Ï„Î¿Ï… Î¼Î¹ÏƒÎ¸Î¯Î¿Ï… ÏƒÎµ Ï„ÏÎ¯Ï„Î¿Ï…Ï‚ ÎºÎ±Î¸ÏÏ‚ ÎºÎ±Î¹ Î· Ï€ÏÏŒÏƒÎ»Î·ÏˆÎ· ÏƒÏ…Î½ÎµÏ„Î±Î¯ÏÎ¿Ï…, Ï‡Ï‰ÏÎ¯Ï‚ Ï„Î·Î½ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î· Î­Î³Î³ÏÎ±Ï†Î· ÏƒÏ…Î½Î±Î¯Î½ÎµÏƒÎ· Ï„Î¿Ï… ÎµÎºÎ¼Î¹ÏƒÎ¸Ï‰Ï„Î®.",
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),

                            // Signatures section
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "Î¤Î¿ Ï€Î±ÏÏŒÎ½ Î¼Î¹ÏƒÎ¸Ï‰Ï„Î®ÏÎ¹Î¿ Î´Î¹Î±Î²Î¬ÏƒÏ„Î·ÎºÎµ ÎºÎ±Î¹ Î­Î³Î¹Î½Îµ Î±Ï€Î¿Î´ÎµÎºÏ„ÏŒ Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ ÏƒÏ…Î¼Î²Î±Î»Î»Î¿Î¼Î­Î½Î¿Ï…Ï‚, Ï…Ï€Î¿Î³ÏÎ¬Ï†Î· Î±Ï€ÏŒ Î±Ï…Ï„Î¿ÏÏ‚ ÎºÎ±Î¹ Î¿ ÎºÎ±Î¸Î­Î½Î±Ï‚ Î­Î»Î±Î²Îµ Î±Ï€ÏŒ Î­Î½Î± ÏŒÎ¼Î¿Î¹Î¿ Î±Î½Ï„Î¯Ï„Ï…Ï€Î¿.",
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { before: 400, after: 300 }
                            }),

                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "ÎŸÎ™ Î£Î¥ÎœÎ’Î‘Î›Î›ÎŸÎœÎ•ÎÎŸÎ™",
                                        bold: true,
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                alignment: AlignmentType.CENTER,
                                spacing: { after: 400 }
                            }),

                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "ÎŸ Î•ÎšÎœÎ™Î£Î˜Î©Î¤Î—Î£",
                                        size: 20,
                                        font: "Times New Roman"
                                    }),
                                    new TextRun({
                                        text: "\t\t\t\tÎ˜Î•Î©Î¡Î—Î˜Î—ÎšÎ•",
                                        size: 20,
                                        font: "Times New Roman"
                                    }),
                                    new TextRun({
                                        text: "\t\t\t\tÎŸ ÎœÎ™Î£Î˜Î©Î¤Î—Î£",
                                        size: 20,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 600 }
                            }),

                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "____________________",
                                        size: 20,
                                        font: "Times New Roman"
                                    }),
                                    new TextRun({
                                        text: "\t\t____________________",
                                        size: 20,
                                        font: "Times New Roman"
                                    }),
                                    new TextRun({
                                        text: "\t\t____________________",
                                        size: 20,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 400 }
                            }),

                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "Î“Î¹Î± Ï„Î¿ Î³Î½Î®ÏƒÎ¹Î¿ Ï„Ï‰Î½ Ï…Ï€Î¿Î³ÏÎ±Ï†ÏÎ½",
                                        size: 22,
                                        font: "Times New Roman"
                                    })
                                ],
                                alignment: AlignmentType.CENTER,
                                spacing: { after: 200 }
                            }),

                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: `Î—ÎœÎ•Î¡ÎŸÎœÎ—ÎÎ™Î‘: ${currentDate}`,
                                        size: 22,
                                        font: "Times New Roman"
                                    })
                                ],
                                alignment: AlignmentType.CENTER
                            })
                        ]
                    }]
                });

                const filename = utils.sanitizeFilename(`Î£Ï…Î¼Ï†Ï‰Î½Î·Ï„Î¹ÎºÏŒ_${agreement.owner.full_name}_${agreement.owner.tin}.docx`);
                
                docx.Packer.toBlob(doc).then(blob => {
                    saveAs(blob, filename);
                    utils.showSuccess(`Î¤Î¿ ÏƒÏ…Î¼Ï†Ï‰Î½Î·Ï„Î¹ÎºÏŒ Î³Î¹Î± ${agreement.owner.full_name} ÎºÎ±Ï„Î­Î²Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!`);
                }).catch(error => {
                    utils.showError('Î£Ï†Î¬Î»Î¼Î± Î±Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·Ï‚ ÎµÎ³Î³ÏÎ¬Ï†Î¿Ï…: ' + error.message);
                });

            } catch (error) {
                utils.showError('Î£Ï†Î¬Î»Î¼Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î±Ï‚ ÎµÎ³Î³ÏÎ¬Ï†Î¿Ï…: ' + error.message);
            }
        }

        // Additional utility functions for future enhancements
        const advancedFeatures = {
            exportToCSV() {
                if (!state.agreements.length) return;
                
                let csvContent = "Î™Î´Î¹Î¿ÎºÏ„Î®Ï„Î·Ï‚,Î‘Î¦Îœ,ÎšÎ¿Î¹Î½ÏŒÏ„Î·Ï„Î±,Î¤Î¿Ï€Î¿Î¸ÎµÏƒÎ¯Î±,Î‘Î¤Î‘Îš,Î‘Ï.ÎšÏ„Î·Î¼.Î¤ÎµÎ¼.,Î§Î±ÏÏ„Î¿Î³ÏÎ±Ï†Î¹ÎºÏŒ,ÎˆÎºÏ„Î±ÏƒÎ·\n";
                
                state.agreements.forEach(agreement => {
                    agreement.fields.forEach(field => {
                        csvContent += `"${agreement.owner.full_name}","${agreement.owner.tin}","${field.community}","${field.location}","${field.atak}","${field.property_number}","${field.cartographic}","${field.area_ha}"\n`;
                    });
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                saveAs(blob, `Î‘Î³ÏÎ¿Î¯_Î£Ï…Î½Î¿Î»Î¹ÎºÏŒÏ‚_ÎšÎ±Ï„Î¬Î»Î¿Î³Î¿Ï‚_${new Date().toISOString().split('T')[0]}.csv`);
            },
            
            printPreview() {
                // Future feature: Show print preview
                console.log('Print preview feature - to be implemented');
            }
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'o':
                        e.preventDefault();
                        elements.jsonFile.click();
                        break;
                    case 'r':
                        e.preventDefault();
                        clearData();
                        break;
                }
            }
        });

        // Auto-save form state (for future enhancement)
        const formState = {
            save() {
                // Future: Save form state to localStorage if needed
            },
            restore() {
                // Future: Restore form state from localStorage if needed
            }
        };
    </script>
</body>
</html>
