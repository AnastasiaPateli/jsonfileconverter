<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ιδιωτικό Συμφωνητικό Αγρομίσθωσης</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.2em;
        }

        .upload-section {
            background: #ecf0f1;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 25px;
            border-left: 4px solid #3498db;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            background: #3498db;
            color: white;
            padding: 12px 24px;
            border-radius: 6px;
            transition: background-color 0.3s;
            margin-right: 15px;
        }

        .file-input-wrapper:hover {
            background: #2980b9;
        }

        .file-input-wrapper input[type="file"] {
            position: absolute;
            left: -9999px;
        }

        .clear-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .clear-btn:hover {
            background: #c0392b;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .stat-item {
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            text-align: center;
            min-width: 120px;
        }

        .stat-item strong {
            display: block;
            font-size: 1.4em;
        }

        .agreement {
            border: 1px solid #ddd;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .agreement h3 {
            color: #2c3e50;
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            font-size: 14px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #34495e;
            color: white;
            font-weight: bold;
        }

        tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .download-btn, .download-all-btn {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            margin: 5px;
        }

        .download-btn:hover, .download-all-btn:hover {
            background: linear-gradient(135deg, #229954, #27ae60);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .download-all-btn {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            font-size: 16px;
            padding: 15px 30px;
            margin: 20px auto;
            display: block;
            width: fit-content;
        }

        .download-all-btn:hover {
            background: linear-gradient(135deg, #7d3c98, #8e44ad);
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            display: none;
        }

        .loading {
            display: none;
            color: #3498db;
            font-weight: bold;
            margin: 10px 0;
        }

        .loading::after {
            content: "";
            animation: dots 1.5s steps(5, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: "."; }
            40% { content: ".."; }
            60% { content: "..."; }
            80%, 100% { content: ""; }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px;
            }
            
            table {
                font-size: 12px;
            }
            
            .stats {
                justify-content: center;
            }
            
            .stat-item {
                min-width: 100px;
            }
        }

        .field-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .owner-info {
            background: #e8f5e8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌾 Ιδιωτικό Συμφωνητικό Αγρομίσθωσης</h1>
        
        <div class="upload-section">
            <h3>📁 Επιλογή Αρχείου JSON</h3>
            <div class="file-input-wrapper">
                <input type="file" id="jsonFile" accept=".json">
                📤 Επιλογή Αρχείου
            </div>
            <button class="clear-btn" id="clearBtn" style="display: none;">🗑️ Καθαρισμός</button>
            
            <div id="error" class="error"></div>
            <div id="success" class="success"></div>
            <div id="loading" class="loading">Φόρτωση δεδομένων</div>
            
            <div class="stats" id="stats" style="display: none;">
                <div class="stat-item">
                    <strong id="totalFields">0</strong>
                    <small>Σύνολο Αγρών</small>
                </div>
                <div class="stat-item">
                    <strong id="totalOwners">0</strong>
                    <small>Ιδιοκτήτες</small>
                </div>
                <div class="stat-item">
                    <strong id="totalArea">0</strong>
                    <small>Συνολική Έκταση (Ha)</small>
                </div>
            </div>
        </div>

        <div class="agreements-section" id="agreements"></div>
    </div>

    <script>
        // State management
        const state = {
            agreements: [],
            tenant: {},
            isProcessing: false
        };

        // DOM elements
        const elements = {
            jsonFile: document.getElementById('jsonFile'),
            clearBtn: document.getElementById('clearBtn'),
            agreements: document.getElementById('agreements'),
            error: document.getElementById('error'),
            success: document.getElementById('success'),
            loading: document.getElementById('loading'),
            stats: document.getElementById('stats'),
            totalFields: document.getElementById('totalFields'),
            totalOwners: document.getElementById('totalOwners'),
            totalArea: document.getElementById('totalArea')
        };

        // Utility functions
        const utils = {
            showError(message) {
                elements.error.textContent = message;
                elements.error.style.display = 'block';
                elements.success.style.display = 'none';
                console.error('Error:', message);
            },

            showSuccess(message) {
                elements.success.textContent = message;
                elements.success.style.display = 'block';
                elements.error.style.display = 'none';
                console.log('Success:', message);
            },

            showLoading(show = true) {
                elements.loading.style.display = show ? 'block' : 'none';
                state.isProcessing = show;
            },

            formatNumber(num) {
                return parseFloat(num).toFixed(2);
            },

            sanitizeFilename(filename) {
                return filename.replace(/[<>:"/\\|?*]/g, '_').substring(0, 100);
            },

            validateJSON(data) {
                if (!data || typeof data !== 'object') {
                    throw new Error('Μη έγκυρα δεδομένα JSON');
                }
                
                if (!data.applicant_detail) {
                    throw new Error('Λείπουν στοιχεία μισθωτή (applicant_detail)');
                }
                
                if (!Array.isArray(data.field_list) || data.field_list.length === 0) {
                    throw new Error('Δεν βρέθηκαν αγροί (field_list)');
                }
                
                return true;
            }
        };

        // Event listeners
        elements.jsonFile.addEventListener('change', handleFileUpload);
        elements.clearBtn.addEventListener('click', clearData);

        // Check library availability
        window.addEventListener('load', () => {
            if (!window.docx || !window.saveAs) {
                utils.showError('Απαιτούμενες βιβλιοθήκες (docx.js ή FileSaver.js) δεν φορτώθηκαν. Δοκιμάστε ξανά.');
            }
        });

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (state.isProcessing) {
                utils.showError('Παρακαλώ περιμένετε να ολοκληρωθεί η προηγούμενη διαδικασία...');
                return;
            }

            utils.showLoading(true);
            elements.clearBtn.style.display = 'inline-block';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    utils.validateJSON(data);
                    
                    setTimeout(() => {
                        generateAgreements(data);
                        utils.showLoading(false);
                        utils.showSuccess(`Φορτώθηκαν επιτυχώς ${state.agreements.length} συμφωνητικά!`);
                    }, 500);
                    
                } catch (error) {
                    utils.showLoading(false);
                    utils.showError('Σφάλμα ανάλυσης αρχείου JSON: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                utils.showLoading(false);
                utils.showError('Σφάλμα ανάγνωσης αρχείου.');
            };
            
            reader.readAsText(file);
        }

        function clearData() {
            elements.jsonFile.value = '';
            elements.agreements.innerHTML = '';
            elements.clearBtn.style.display = 'none';
            elements.stats.style.display = 'none';
            elements.error.style.display = 'none';
            elements.success.style.display = 'none';
            state.agreements = [];
            state.tenant = {};
        }

        function generateAgreements(data) {
            state.tenant = data.applicant_detail || {};
            const fields = data.field_list || [];
            const agreementsByTin = {};
            let totalFields = 0;
            let totalArea = 0;

            // Process fields and group by owner TIN
            fields.forEach(field => {
                const fieldInfo = field.field_info || {};
                const propertyList = Array.isArray(field.field_property_list) ? field.field_property_list : [];
                const geospatialData = field.field_geospatial_data || {};

                propertyList.forEach(property => {
                    const tin = property.tin || `unknown_${Math.random().toString(36).substr(2, 9)}`;
                    
                    if (!agreementsByTin[tin]) {
                        agreementsByTin[tin] = {
                            owner: {
                                tin: property.tin || 'Άγνωστο',
                                full_name: property.full_name || 'Άγνωστος Ιδιοκτήτης',
                                father_name: property.father_name || '-',
                                doy: 'Α\' Σερρών'
                            },
                            fields: []
                        };
                    }
                    
                    const area = parseFloat(property.area_participation_atak) || 0;
                    totalArea += area;
                    totalFields++;
                    
                    agreementsByTin[tin].fields.push({
                        community: fieldInfo.location ? fieldInfo.location.split('-')[0] : 'Άγνωστη',
                        location: fieldInfo.location || 'Άγνωστη',
                        atak: property.atak || '-',
                        property_number: property.legal_possession_document_number || '-',
                        cartographic: geospatialData.cartographic_background || '-',
                        area_ha: area.toFixed(2)
                    });
                });
            });

            state.agreements = Object.values(agreementsByTin);
            
            // Update stats
            elements.totalFields.textContent = totalFields;
            elements.totalOwners.textContent = state.agreements.length;
            elements.totalArea.textContent = totalArea.toFixed(2);
            elements.stats.style.display = 'flex';

            renderAgreements();
        }

        function renderAgreements() {
            elements.agreements.innerHTML = '';

            if (state.agreements.length > 1) {
                const downloadAllBtn = document.createElement('button');
                downloadAllBtn.className = 'download-all-btn';
                downloadAllBtn.innerHTML = '📦 Λήψη Όλων των Συμφωνητικών (ZIP)';
                downloadAllBtn.onclick = () => downloadAllAgreements();
                elements.agreements.appendChild(downloadAllBtn);
            }

            state.agreements.forEach((agreement, index) => {
                const agreementDiv = document.createElement('div');
                agreementDiv.className = 'agreement';
                
                const totalAreaForOwner = agreement.fields.reduce((sum, field) => 
                    sum + parseFloat(field.area_ha), 0
                );
                
                agreementDiv.innerHTML = `
                    <h3>📋 Συμφωνητικό #${index + 1}</h3>
                    <div class="owner-info">
                        <strong>Ιδιοκτήτης:</strong> ${agreement.owner.full_name}<br>
                        <strong>Α.Φ.Μ:</strong> ${agreement.owner.tin}<br>
                        <strong>Σύνολο αγρών:</strong> ${agreement.fields.length}<br>
                        <strong>Συνολική έκταση:</strong> ${totalAreaForOwner.toFixed(2)} Ha
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Α/Α</th>
                                <th>ΚΟΙΝΟΤΗΤΑ</th>
                                <th>ΤΟΠΟΘΕΣΙΑ</th>
                                <th>Α.Τ.Α.Κ.</th>
                                <th>ΑΡ.ΚΤΗΜ.ΤΕΜ.</th>
                                <th>ΧΑΡΤΟΓΡΑΦΙΚΟ</th>
                                <th>ΕΚΤΑΣΗ (Ha)</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${agreement.fields.map((field, fieldIndex) => `
                                <tr>
                                    <td>${fieldIndex + 1}</td>
                                    <td>${field.community}</td>
                                    <td>${field.location}</td>
                                    <td>${field.atak}</td>
                                    <td>${field.property_number}</td>
                                    <td>${field.cartographic}</td>
                                    <td>${field.area_ha}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-btn';
                downloadBtn.innerHTML = '⬇️ Λήψη Συμφωνητικού';
                downloadBtn.onclick = () => generateDocx(agreement);
                agreementDiv.appendChild(downloadBtn);

                elements.agreements.appendChild(agreementDiv);
            });
        }

        async function downloadAllAgreements() {
            if (!window.JSZip) {
                // Fallback: download individual files
                utils.showError('Δεν είναι διαθέσιμη η δυνατότητα ZIP. Κατεβάστε τα αρχεία ξεχωριστά.');
                return;
            }
            
            // For now, just download them individually
            for (let i = 0; i < state.agreements.length; i++) {
                await new Promise(resolve => {
                    setTimeout(() => {
                        generateDocx(state.agreements[i]);
                        resolve();
                    }, 1000 * i); // Stagger downloads
                });
            }
        }

        function generateDocx(agreement) {
            if (!window.docx || !window.saveAs) {
                utils.showError('Απαιτούμενες βιβλιοθήκες δεν είναι φορτωμένες.');
                return;
            }

            try {
                const { Document, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, AlignmentType } = docx;
                const currentDate = new Date().toLocaleDateString('el-GR');

                const doc = new Document({
                    sections: [{
                        children: [
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "ΙΔΙΩΤΙΚΟ ΣΥΜΦΩΝΗΤΙΚΟ ΑΓΡΟΜΙΣΘΩΣΗΣ",
                                        bold: true,
                                        size: 28,
                                        font: "Times New Roman"
                                    })
                                ],
                                alignment: AlignmentType.CENTER,
                                spacing: { after: 400 }
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: `Σήμερα την ${currentDate} στο Δημητρίτσι οι υπογράφοντες το συμφωνητικό αυτό`,
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: `αφενός ο/η ${agreement.owner.full_name} του ${agreement.owner.father_name || '-'}, κάτοικος -, οδός -, αρ. -, Α.Φ.Μ ${agreement.owner.tin}, Δ.Ο.Υ ${agreement.owner.doy}`,
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: `και αφετέρου ο/η ${state.tenant.first_name || 'Άγνωστο'} ${state.tenant.last_name || 'Όνομα'} του ${state.tenant.father_name || '-'}, επαγγέλματος αγρότης, κάτοικος ${state.tenant.post_code || '-'}, οδός ${state.tenant.street || '-'}, αρ. ${state.tenant.street_number || '-'}, Α.Φ.Μ ${state.tenant.tin || '-'}, Δ.Ο.Υ Α\' Σερρών`,
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "συμφώνησαν από κοινού και αποδέχτηκαν τα εξής:",
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 300 }
                            }),
                            
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "1. ΜΙΣΘΙΟ. ",
                                        bold: true,
                                        size: 24,
                                        font: "Times New Roman"
                                    }),
                                    new TextRun({
                                        text: "Ο πρώτος συμβαλλόμενος (\"εκμισθωτής\") έχει στην αποκλειστική κυριότητα, νομή και κατοχή του τους κάτωθι αγρούς:",
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),

                            // Fields table
                            new Table({
                                width: { size: 100, type: WidthType.PERCENTAGE },
                                rows: [
                                    new TableRow({
                                        children: [
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Α/Α", bold: true })] })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ΚΟΙΝΟΤΗΤΑ", bold: true })] })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ΤΟΠΟΘΕΣΙΑ", bold: true })] })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "Α.Τ.Α.Κ.", bold: true })] })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ΑΡ.ΚΤΗΜ.ΤΕΜ.", bold: true })] })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ΧΑΡΤΟΓΡΑΦΙΚΟ", bold: true })] })] }),
                                            new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "ΕΚΤΑΣΗ (Ha)", bold: true })] })] })
                                        ]
                                    }),
                                    ...agreement.fields.map((field, index) => new TableRow({
                                        children: [
                                            new TableCell({ children: [new Paragraph(`${index + 1}`)] }),
                                            new TableCell({ children: [new Paragraph(field.community)] }),
                                            new TableCell({ children: [new Paragraph(field.location)] }),
                                            new TableCell({ children: [new Paragraph(field.atak)] }),
                                            new TableCell({ children: [new Paragraph(field.property_number)] }),
                                            new TableCell({ children: [new Paragraph(field.cartographic)] }),
                                            new TableCell({ children: [new Paragraph(field.area_ha.toString())] })
                                        ]
                                    }))
                                ]
                            }),

                            // Contract terms
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "Ο εκμισθωτής εκμισθώνει με το παρόν συμφωνητικό στο μισθωτή τους παραπάνω αγρούς, με τους εξής όρους και συμφωνίες που είναι όλοι ουσιώδεις:",
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { before: 300, after: 200 }
                            }),

                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "2. ΔΙΑΡΚΕΙΑ. ",
                                        bold: true,
                                        size: 24,
                                        font: "Times New Roman"
                                    }),
                                    new TextRun({
                                        text: "Η διάρκεια της παρούσας μίσθωσης ορίζεται: Αρχίζει την 1η ΝΟΕΜΒΡΙΟΥ 2024 και λήγει την 31η ΟΚΤΩΒΡΙΟΥ 2032.",
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),

                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "3. ΜΙΣΘΩΜΑ. ",
                                        bold: true,
                                        size: 24,
                                        font: "Times New Roman"
                                    }),
                                    new TextRun({
                                        text: "Το ετήσιο μίσθωμα ορίζεται σε ευρώ _____ /στρέμμα",
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),

                            // Additional contract terms...
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "4. ΧΡΗΣΗ. ",
                                        bold: true,
                                        size: 24,
                                        font: "Times New Roman"
                                    }),
                                    new TextRun({
                                        text: "Ο μίσθιος αγρός θα χρησιμοποιηθεί αποκλειστικά για αγροτική καλλιέργεια. Απαγορεύεται απόλυτα οποιαδήποτε μετατροπή της χρήσης ή του τρόπου εκμετάλλευσης του μισθίου, η ολική ή μερική υπομίσθωσή του, ή η με οποιοδήποτε τρόπο, με ή χωρίς αντάλλαγμα παραχώρηση της χρήσης του μισθίου σε τρίτους καθώς και η πρόσληψη συνεταίρου, χωρίς την προηγούμενη έγγραφη συναίνεση του εκμισθωτή.",
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 200 }
                            }),

                            // Signatures section
                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "Το παρόν μισθωτήριο διαβάστηκε και έγινε αποδεκτό από τους συμβαλλομένους, υπογράφη από αυτούς και ο καθένας έλαβε από ένα όμοιο αντίτυπο.",
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { before: 400, after: 300 }
                            }),

                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "ΟΙ ΣΥΜΒΑΛΛΟΜΕΝΟΙ",
                                        bold: true,
                                        size: 24,
                                        font: "Times New Roman"
                                    })
                                ],
                                alignment: AlignmentType.CENTER,
                                spacing: { after: 400 }
                            }),

                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "Ο ΕΚΜΙΣΘΩΤΗΣ",
                                        size: 20,
                                        font: "Times New Roman"
                                    }),
                                    new TextRun({
                                        text: "\t\t\t\tΘΕΩΡΗΘΗΚΕ",
                                        size: 20,
                                        font: "Times New Roman"
                                    }),
                                    new TextRun({
                                        text: "\t\t\t\tΟ ΜΙΣΘΩΤΗΣ",
                                        size: 20,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 600 }
                            }),

                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "____________________",
                                        size: 20,
                                        font: "Times New Roman"
                                    }),
                                    new TextRun({
                                        text: "\t\t____________________",
                                        size: 20,
                                        font: "Times New Roman"
                                    }),
                                    new TextRun({
                                        text: "\t\t____________________",
                                        size: 20,
                                        font: "Times New Roman"
                                    })
                                ],
                                spacing: { after: 400 }
                            }),

                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: "Για το γνήσιο των υπογραφών",
                                        size: 22,
                                        font: "Times New Roman"
                                    })
                                ],
                                alignment: AlignmentType.CENTER,
                                spacing: { after: 200 }
                            }),

                            new Paragraph({
                                children: [
                                    new TextRun({
                                        text: `ΗΜΕΡΟΜΗΝΙΑ: ${currentDate}`,
                                        size: 22,
                                        font: "Times New Roman"
                                    })
                                ],
                                alignment: AlignmentType.CENTER
                            })
                        ]
                    }]
                });

                const filename = utils.sanitizeFilename(`Συμφωνητικό_${agreement.owner.full_name}_${agreement.owner.tin}.docx`);
                
                docx.Packer.toBlob(doc).then(blob => {
                    saveAs(blob, filename);
                    utils.showSuccess(`Το συμφωνητικό για ${agreement.owner.full_name} κατέβηκε επιτυχώς!`);
                }).catch(error => {
                    utils.showError('Σφάλμα αποθήκευσης εγγράφου: ' + error.message);
                });

            } catch (error) {
                utils.showError('Σφάλμα δημιουργίας εγγράφου: ' + error.message);
            }
        }

        // Additional utility functions for future enhancements
        const advancedFeatures = {
            exportToCSV() {
                if (!state.agreements.length) return;
                
                let csvContent = "Ιδιοκτήτης,ΑΦΜ,Κοινότητα,Τοποθεσία,ΑΤΑΚ,Αρ.Κτημ.Τεμ.,Χαρτογραφικό,Έκταση\n";
                
                state.agreements.forEach(agreement => {
                    agreement.fields.forEach(field => {
                        csvContent += `"${agreement.owner.full_name}","${agreement.owner.tin}","${field.community}","${field.location}","${field.atak}","${field.property_number}","${field.cartographic}","${field.area_ha}"\n`;
                    });
                });
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                saveAs(blob, `Αγροί_Συνολικός_Κατάλογος_${new Date().toISOString().split('T')[0]}.csv`);
            },
            
            printPreview() {
                // Future feature: Show print preview
                console.log('Print preview feature - to be implemented');
            }
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'o':
                        e.preventDefault();
                        elements.jsonFile.click();
                        break;
                    case 'r':
                        e.preventDefault();
                        clearData();
                        break;
                }
            }
        });

        // Auto-save form state (for future enhancement)
        const formState = {
            save() {
                // Future: Save form state to localStorage if needed
            },
            restore() {
                // Future: Restore form state from localStorage if needed
            }
        };
    </script>
</body>
</html>
