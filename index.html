<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agreements Generator by Owner</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 1em; }
    .agreement { border: 1px solid #222; margin: 1em 0; padding: 1em; background: #f8f8f8; }
    .owner-title { font-weight: bold; font-size: 1.2em; margin-bottom: 0.6em; }
    pre { background: #eee; }
  </style>
</head>
<body>
  <h1>Generate Agreements by Owner (TIN)</h1>
  <input type="file" id="fileInput" accept=".json"/>
  <div id="output"></div>

  <script>
    // Utility: Agreement Template (customize as appropriate)
    function agreementTemplate(owner, fields) {
      return `
        <div class="agreement">
          <div class="owner-title">ΣΥΜΦΩΝΗΤΙΚΟ ΕΝΟΙΚΙΑΣΗΣ ΑΓΡΟΥ - ${owner.full_name} (ΑΦΜ: ${owner.tin})</div>
          <p><strong>Ιδιοκτήτης:</strong> ${owner.full_name} (ΑΦΜ: ${owner.tin})</p>
          <p><strong>Ενοικιαστής:</strong> [Στοιχεία Ενοικιαστή συμπληρώστε εδώ]</p>
          <p>Περίληψη συμφωνίας για τα ακόλουθα αγροτεμάχια:</p>
          <ul>
            ${fields.map(f => `
              <li>
                <strong>Τοποθεσία:</strong> ${f.location}
                <br><strong>Έκταση:</strong> ${f.area} στρέμματα
                <br><strong>Συμβόλαιο:</strong> Από ${f.rental_start} έως ${f.rental_end}
                <br><strong>Κωδικός Αγρού/Τίτλου:</strong> ${f.property_title_code}
              </li>
            `).join('')}
          </ul>
          <p><em>Η συμφωνία αυτή καλύπτει όλα τα ανωτέρω αγροτεμάχια που ανήκουν στον ίδιο ιδιοκτήτη.</em></p>
        </div>
      `;
    }

    // Parse and organize agreements by TIN
    function processJson(data) {
      // Will store { tin: { owner: {tin, full_name, ...}, fields: [fieldData, ...] } }
      const agreementsByTin = {};

      // Process each field in the field_list
      (data.field_list || []).forEach(field => {
        // Each field can have multiple property/owners
        (field.field_property_list || []).forEach(ownerProp => {
          // Identify owner by TIN, merge if already exists
          if (!agreementsByTin[ownerProp.tin]) {
            agreementsByTin[ownerProp.tin] = {
              owner: {
                tin: ownerProp.tin,
                full_name: ownerProp.full_name
              },
              fields: []
            };
          }
          agreementsByTin[ownerProp.tin].fields.push({
            location: field.field_info && field.field_info.location ? field.field_info.location : 'Άγνωστη',
            area: field.field_geospatial_data && field.field_geospatial_data.area ? field.field_geospatial_data.area : 'N/A',
            rental_start: ownerProp.rental_start_date ? ownerProp.rental_start_date.split(' ')[0] : '-',
            rental_end: ownerProp.rental_end_date ? ownerProp.rental_end_date.split(' ')[0] : '-',
            property_title_code: ownerProp.property_title_code || ''
          });
        });
      });

      return agreementsByTin;
    }

    // Display agreements as HTML
    function displayAgreements(agreementsByTin) {
      const container = document.getElementById('output');
      container.innerHTML = '';
      Object.values(agreementsByTin).forEach(({owner, fields}) => {
        container.innerHTML += agreementTemplate(owner, fields);
      });
    }

    // File Input Handler
    document.getElementById('fileInput').addEventListener('change', function(event){
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        let jsonData = null;
        try {
          jsonData = JSON.parse(e.target.result);
        } catch (err) {
          alert('Το αρχείο δεν είναι σωστό JSON!');
          return;
        }
        const agreementsByTin = processJson(jsonData);
        displayAgreements(agreementsByTin);
      };
      reader.readAsText(file);
    });
  </script>
</body>
</html>

